lerna.akka.entityreplication {

  // TODO: consider a better default value
  // Time to interrupt replication for events that are taking too long
  // ** This default value may not be appropriate **
  replication-timeout = 3000 ms

  // How long wait before giving up entity recovery.
  // Entity recovery requires a snapshot, and failure fetching it will cause this timeout.
  // If timed out, entity recovery will be retried.
  recovery-entity-timeout = 10s

  raft {
    // The time it takes to start electing a new leader after the heartbeat is no longer received from the leader.
    election-timeout = 750 ms

    // The interval between leaders sending heartbeats to their followers
    heartbeat-interval = 100 ms

    // A role to identify the nodes to place replicas on
    // The number of roles is the number of replicas. It is recommended to set up at least three roles.
    multi-raft-roles = ["replica-group-1", "replica-group-2", "replica-group-3"]

    // log compaction settings
    compaction {

      // Time interval to check the size of the log and check if a snapshotting is needed to be taken
      log-size-check-interval = 10s

      // Threshold for saving snapshots and compaction of the log
      log-size-threshold = 50000

      // Preserving log entries from log reduction to avoid log replication failure.
      // If more number of logs than this value cannot be synchronized, the raft member will be unavailable.
      // This size is usually less than log-size-threshold
      preserve-log-size = 10000

      // Time to keep a cache of snapshots in memory
      snapshot-cache-time-to-live = 10s
    }

    sharding = ${akka.cluster.sharding} {
      // Maximum number of messages that are buffered by a ShardRegion actor.
      // Make it smaller than the default value to discard messages that are too old.
      buffer-size = 1000
    }

    // data persistent settings
    persistence {
      // Absolute path to the journal plugin configuration entry.
      // The journal will be stored events which related to Raft.
      journal.plugin = "lerna.akka.entityreplication.raft.persistence.cassandra.journal"

      // Absolute path to the snapshot store plugin configuration entry.
      // The snapshot store will be stored state which related to Raft.
      snapshot-store.plugin = "lerna.akka.entityreplication.raft.persistence.cassandra.snapshot"
    }

    // The settings for Cassandra persistence plugin
    persistence.cassandra = ${akka.persistence.cassandra}
    persistence.cassandra {

      // Profile to use.
      // See https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/ for overriding any settings
      read-profile = "akka-entity-replication-profile"
      write-profile = "akka-entity-replication-profile"

      journal {

        // replication strategy to use.
        replication-strategy = "NetworkTopologyStrategy"

        // Replication factor list for data centers, e.g. ["dc0:3", "dc1:3"]. This setting is only used when replication-strategy is NetworkTopologyStrategy.
        // Replication factors should be 3 or more to maintain data consisstency.
        data-center-replication-factors = ["dc0:3"]

        // To limit the Cassandra hosts this plugin connects with to a specific datacenter.
        local-datacenter = "dc0"

        // Name of the keyspace to be used by the journal
        keyspace = "entity_replication"
      }

      snapshot {

        // Profile to use.
        // See https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/ for overriding any settings
        read-profile = "akka-entity-replication-snapshot-profile"
        write-profile = "akka-entity-replication-snapshot-profile"

        // replication strategy to use.
        replication-strategy = "NetworkTopologyStrategy"

        // Replication factor list for data centers, e.g. ["dc0:3", "dc1:3"]. This setting is only used when replication-strategy is NetworkTopologyStrategy.
        // Replication factors should be 3 or more to maintain data consisstency.
        data-center-replication-factors = ["dc0:3"]

        // To limit the Cassandra hosts this plugin connects with to a specific datacenter.
        local-datacenter = "dc0"

        // Name of the keyspace to be used by the snapshot store
        keyspace = "entity_replication_snapshot"
      }
    }
  }

  raft.eventhandler {
    // Settings for saving committed events from each RaftActor
    commit-log-store {
      // Retry setting to prevent events from being lost if commit-log-store(sharding) stops temporarily
      retry {
        attempts = 15
        delay = 3 seconds
      }
    }

    persistence {
      // Absolute path to the journal plugin configuration entry.
      // The journal stores Raft-committed events.
      journal.plugin = "lerna.akka.entityreplication.raft.eventhandler.persistence.cassandra.journal"

      // Absolute path to the query plugin configuration entry.
      // The query is used by Raft EventHandler.
      query.plugin = "lerna.akka.entityreplication.raft.eventhandler.persistence.cassandra.query"
    }

    // cassandra-journal & cassandra-query-journal to save committed events
    persistence.cassandra = ${akka.persistence.cassandra}
    persistence.cassandra = {

      // Profile to use.
      // See https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/ for overriding any settings
      read-profile = "akka-entity-replication-profile"
      write-profile = "akka-entity-replication-profile"

      journal {

        // replication strategy to use.
        replication-strategy = "NetworkTopologyStrategy"

        // Replication factor list for data centers, e.g. ["dc0:3", "dc1:3"]. This setting is only used when replication-strategy is NetworkTopologyStrategy.
        // Replication factors should be 3 or more to maintain data consisstency.
        data-center-replication-factors = ["dc0:3"]

        // To limit the Cassandra hosts this plugin connects with to a specific datacenter.
        local-datacenter = "dc0"

        // Name of the keyspace to be used by the journal
        keyspace = "raft_commited_event"

        // Tagging to allow some RaftActor(Shard) to handle individually committed events together(No need to change)
        event-adapters {
          tagging = "lerna.akka.entityreplication.raft.eventhandler.TaggingEventAdapter"
        }
        event-adapter-bindings {
          "java.lang.Object" = tagging
        }
      }
    }
  }
}

// You can find reference configuration at
// https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/
// see also: https://doc.akka.io/docs/akka-persistence-cassandra/1.0.3/configuration.html#cassandra-driver-configuration
datastax-java-driver {
  profiles {

    // It is recommended to set this value.
    // For more details see https://doc.akka.io/docs/akka-persistence-cassandra/1.0.3/configuration.html#cassandra-driver-configuration
    // advanced.reconnect-on-init = true

    akka-entity-replication-profile {
      basic.request {
        // Important: akka-entity-replication recommends quorum based consistency level to remain data consistency
        consistency = LOCAL_QUORUM
        // the journal does not use any counters or collections
        default-idempotence = true
      }
    }

    akka-entity-replication-snapshot-profile {
      basic.request {
        // Important: akka-entity-replication recommends quorum based consistency level to remain data consistency
        consistency = LOCAL_QUORUM
        // the snapshot store does not use any counters or collections
        default-idempotence = true
      }
    }
  }
}
